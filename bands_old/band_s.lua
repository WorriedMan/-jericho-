local coords={
	{ 1, 1390.029297, 833.430664, 6.8125 },
	{ 2, 1808.774414, 832.457031, 10.671875 },
	{ 3, 2217.459961, 831.272461, 6.734375 },
	{ 4, 2481.483398, 827.693359, 6.83638 },
	{ 5, 2637.213867, 894.944336, 7.581398 },
	{ 6, 2750.291016, 1089.25, 9.731178 },
	{ 7, 2727.553711, 1344.885742, 6.734375 },
	{ 8, 2727.564453, 1767.878906, 6.734375 },
	{ 9, 2822.144531, 1889.825195, 10.820313 },
	{ 10, 2860.637695, 2126.441406, 10.820313 },
	{ 11, 2868.022461, 2291.341797, 10.671875 },
	{ 12, 2787.045898, 2295.291992, 10.870286 },
	{ 13, 2720.293945, 2361.84082, 6.734375 },
	{ 14, 2651.076172, 2552.130859, 10.820313 },
	{ 15, 2414.114258, 2638.516602, 6.656689 },
	{ 16, 2176.021484, 2622.751953, 7.762846 },
	{ 17, 1873.324219, 2524.661133, 6.812854 },
	{ 18, 1568.613281, 2475.249023, 6.734375 },
	{ 19, 1308.425781, 2474.382813, 7.395226 },
	{ 20, 1208.205078, 2334.914063, 7.437688 },
	{ 21, 1204.331055, 1938.135742, 6.741999 },
	{ 22, 1216.333008, 1447.651367, 6.708274 },
	{ 23, 1234.151367, 1067.491211, 6.869281 },
	{ 24, 1273.685547, 911.776367, 6.8125 },
	{ 25, 1353.676758, 844.633789, 6.8125 },
	{ 26, 2026.822266, 39.646484, 29.65012 },
	{ 27, 2294.008789, 41.957031, 26.335938 },
	{ 28, 2293.759766, 92.398438, 26.335938 },
	{ 29, 2224.047852, 91.717773, 26.341249 },
	{ 30, 2217.766602, 137.608398, 26.484375 },
	{ 31, 2212.318359, 196.624023, 18.772343 },
	{ 32, 2229.421875, 222.59668, 14.645967 },
	{ 33, 2299.745117, 142.242188, 26.484375 },
	{ 34, 2299.500977, 214.560547, 23.886185 },
	{ 35, 2344.171875, 92.563477, 26.332047 },
	{ 36, 2343.355469, 215.772461, 26.33514 },
	{ 37, 2391.06543, 90.925781, 26.335938 },
	{ 38, 2394.536133, 40.422852, 26.33651 },
	{ 39, 2534.076172, 42.188477, 26.335938 },
	{ 40, 2530.642578, -8.94043, 26.335938 },
	{ 41, 2464.691406, -8.760742, 26.335938 },
	{ 42, 2451.03125, -30.050781, 26.335938 },
	{ 43, 2340.790039, -29.025391, 26.335938 },
	{ 44, 2293.12207, -28.783203, 26.335938 },
	{ 45, 2292.681641, -98.844727, 26.338572 },
	{ 46, 2346.705078, -98.016602, 26.484375 },
	{ 47, 2464.607422, -101.442383, 30.881084 },
	{ 48, 2059.197266, 257.322266, 25.207876 },
	{ 49, 2001.107422, 245.914063, 27.420027 },
	{ 50, 1969.232422, 156.969727, 34.823318 },
	{ 51, 1944.931641, 85.166016, 29.269936 },
	{ 52, 2007.577148, 68.583984, 30.054207 },
	{ 53, -82.549805, 2561.994141, 17.585423 },
	{ 54, -146.164063, 2553.685547, 25.3328 },
	{ 55, -177.064453, 2508.374023, 24.657734 },
	{ 56, -240.987305, 2515.256836, 30.72086 },
	{ 57, -284.860352, 2523.921875, 34.27013 },
	{ 58, -336.888672, 2524.806641, 35.51738 },
	{ 59, -374.69043, 2566.40332, 40.472652 },
	{ 60, -393.952148, 2587.107422, 41.451923 },
	{ 61, -397.944336, 2642.602539, 48.201019 },
	{ 62, -423.364258, 2715.013672, 62.269081 },
	{ 63, -437.161133, 2593.176758, 45.702557 },
	{ 64, -491.092773, 2591.729492, 53.319328 },
	{ 65, -545.763672, 2661.186523, 55.422756 },
	{ 66, -557.980469, 2705.509766, 67.430923 },
	{ 67, -514.102539, 2714.458008, 65.971039 },
	{ 68, -447.021484, 2673.181641, 52.930534 },
	{ 69, -340.407227, 2561.574219, 37.822899 },
	{ 70, -241.698242, 2531.759766, 32.342579 },
	{ 71, -176.7724609375, 2534.412109375, 28.215291976929 },
	{ 72, -117.755859375, 2525.0869140625, 19.299974441528 },
	{ 73, -47.0888671875, 2643.3232421875, 63.007270812988 },
	{ 74, 12.48828125, 2641.3251953125, 59.884384155273 },
	{ 75, 102.1171875, 2690.689453125, 52.347648620605 },
	{ 76, 195.380859375, 2758.724609375, 58.409393310547 },
	{ 77, 112.78515625, 2719.28125, 52.660614013672 },
	{ 78, 47.2109375, 2665.48828125, 55.292900085449 },
	{ 79, -1660.9716796875, 2022.4365234375, 18.730613708496 },
	{ 80, -1689.05078125, 1896.0234375, 21.94527053833 },
	{ 81, -1686.970703125, 1821.8115234375, 25.456476211548 },
	{ 82, -1530.6923828125, 1842.8076171875, 29.08429145813 },
	{ 83, -1591.96875, 1938.8876953125, 21.312881469727 },
	{ 84, -1635.09765625, 1893.8701171875, 16.19917678833 },
	{ 85, -1637.40234375, 1820.59765625, 12.992067337036 },
	{ 86, -1583.84375, 1749.4931640625, 7.424370765686 },
	{ 87, -1674.3671875, 1783.5830078125, 21.458936691284 },
	{ 88, -1479.5634765625, 1706.552734375, 2.5754375457764 },
	{ 89, -1341.87109375, 1701.6015625, 6.0230350494385 },
	{ 90, -1226.859375, 1659.1826171875, 11.913913726807 },
	{ 91, -1156.7578125, 1616.6083984375, 19.089061737061 },
	{ 92, -1148.041015625, 1644.1865234375, 24.338268280029 },
	{ 93, -1248.94921875, 1722.466796875, 17.075532913208 },
	{ 94, -1392.1572265625, 1741.705078125, 16.967073440552 },
	{ 95, -1545.544921875, 1768.0078125, 17.035224914551 },
	{ 96, -1616.64453125, 1839.890625, 16.863094329834 },
	{ 97, -1618.8125, 1893.947265625, 16.700113296509 },
}

local connections={
	{ 1, 2, },
	{ 2, 3, },
	{ 3, 4, },
	{ 4, 5, },
	{ 5, 6, },
	{ 6, 7, },
	{ 7, 8, },
	{ 8, 9, 13, },
	{ 9, 10, },
	{ 10, 11, },
	{ 11, 12, },
	{ 12, 13, },
	{ 13, 14, },
	{ 14, 15, },
	{ 15, 16, },
	{ 16, 17, },
	{ 17, 18, },
	{ 18, 19, },
	{ 19, 20, },
	{ 20, 21, },
	{ 21, 22, },
	{ 22, 23, },
	{ 23, 24, },
	{ 24, 25, },
	{ 25, 1, },
	{ 26, 27, },
	{ 27, 28, },
	{ 28, 29, 35, },
	{ 29, 30, },
	{ 30, 31, 33, },
	{ 31, 32, },
	{ 32, 48, },
	{ 33, 34, 28, },
	{ 34, 32, },
	{ 35, 36, 37, },
	{ 36, 34, },
	{ 37, 38, },
	{ 38, 39, },
	{ 39, 40, },
	{ 40, 41, },
	{ 41, 42, },
	{ 42, 43, },
	{ 43, 44, },
	{ 44, 27, 45, },
	{ 45, 46, },
	{ 46, 43, 47, },
	{ 47, 41, },
	{ 48, 49, },
	{ 49, 50, },
	{ 50, 51, },
	{ 51, 52, },
	{ 52, 26, },
	{ 53, 54, },
	{ 54, 55, },
	{ 55, 56, },
	{ 56, 57, 70, },
	{ 57, 58, 70, },
	{ 58, 59, 69, },
	{ 59, 60, },
	{ 60, 61, 63, },
	{ 61, 62, },
	{ 62, 68, },
	{ 63, 64, },
	{ 64, 65, },
	{ 65, 66, },
	{ 66, 67, },
	{ 67, 62, },
	{ 68, 69, },
	{ 69, 70, 58, 57, },
	{ 70, 56, 71, },
	{ 71, 72, },
	{ 72, 53, },
	{ 73, 74, },
	{ 74, 75, },
	{ 75, 76, },
	{ 76, 77, },
	{ 77, 78, },
	{ 78, 73, },
	{ 79, 80, 84, },
	{ 80, 81, },
	{ 81, 82, 87, },
	{ 82, 83, },
	{ 83, 79, },
	{ 84, 85, },
	{ 85, 86, },
	{ 86, 88, },
	{ 87, 86, },
	{ 88, 89, },
	{ 89, 90, },
	{ 90, 91, },
	{ 91, 92, },
	{ 92, 93, },
	{ 93, 94, },
	{ 94, 95, },
	{ 95, 96, },
	{ 96, 97, },
	{ 97, 79, },
}

local cfg = { -- { точки спавна }, минимум педов, максимум, { возможные пушки }, { скины }, количество вещей
	{ { 1, 2, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25 }, 4, 5, {1,2,3,4,5,6}, { 66, 67, 68, 60, 158, 159, 160 }, 3 },
--	{ { 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 41, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52 }, 1, 2, { 3, 4, 6 }, { 66, 67, 68, 60, 158, 159, 160 }, 3 },
--	{ { 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 41, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52 }, 1, 2, { 3, 4, 6 }, { 66, 67, 68, 60, 158, 159, 160 }, 3 },
	{ { 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97 }, 1, 5, { 3, 4, 6 }, { 66, 67, 68, 60, 158, 159, 160 }, 3 },
}

local bands = {}

local weapon = {
	{ 30, 1000, 50, 20, 100, 6 },
	{ 5, 1, 2, 2, 10, 1 },
	{ 24, 1000, 40, 15, 40, 4 },
	{ 25, 1000, 25, 10, 40, 5 },
	{ 31, 1000, 50, 20, 100, 6 },
	{ 29, 1000, 50, 20, 100, 5 },

}

function createBanditos ()
	for b = 1, #cfg do 
		--local posID = 8
		local posID = math.random ( 1, #cfg[b][1] )
		local connID = math.random ( 2, #connections[posID] )
		local x,y,z = coords[cfg[b][1][posID]][2], coords[cfg[b][1][posID]][3], coords[cfg[b][1][posID]][4]
		local pedsTable = {}
		local sphere
		for i = 1, math.random ( cfg[b][2], cfg[b][3] ) do
			local offX, offY = math.random ( -2, 2 ), math.random ( -2, 2 )
			local createdPed = createPed ( cfg[b][5][math.random(1,#cfg[b][5])], x+offX,y+offY,z )
			if i == 1 then
				offX, offY = 0, 0
				sphere = createColSphere ( x, y,z, 60 )
				setElementData ( sphere, "banditLink", createdPed )
				setElementData ( sphere, "banditSphere", true )
				setElementData ( createdPed, "sphereLink", sphere )
				attachElements ( sphere, createdPed )
				setElementData ( createdPed, "leader", true )
				--createBlipAttachedTo ( createdPed )
			end
			setElementData ( createdPed, "maxHealth", math.random ( 100, 400 ) )
			setElementData ( createdPed, "health", getElementData ( createdPed, 'maxHealth' ) )
			setElementData ( createdPed, "changes", 0 )
			setElementData ( createdPed, "sphereLink", sphere )
			setElementData ( createdPed, "bandID", b )
			setElementData ( createdPed, "conn", connections[cfg[b][1][posID]][connID] )
			setElementData ( createdPed, "offX", offX )
			setElementData ( createdPed, "offY", offY )
			setElementData ( createdPed, "bandit", true )
			exports.npc_hlc:enableHLCForNPC( createdPed, "walk")
			local weap = math.random ( 1, #cfg[b][4] )
			giveWeapon ( createdPed, weapon[cfg[b][4][weap]][1], weapon[cfg[b][4][weap]][2], true )
			setElementData ( createdPed, "weapon", cfg[b][4][weap] )
			setPedArmor ( createdPed, weapon[cfg[b][4][weap]][5] )
			setElementData ( createdPed, "attS", weapon[cfg[b][4][weap]][3] )
			setElementData ( createdPed, "attD", weapon[cfg[b][4][weap]][4] )
			setElementData ( createdPed, 'itemsAmount', weapon[cfg[b][4][weap]][6]+cfg[b][6] )
			table.insert ( pedsTable, createdPed )
			exports.npc_hlc:addNPCTask ( createdPed, {"walkToPos", coords[connections[cfg[b][1][posID]][connID]][2],coords[connections[cfg[b][1][posID]][connID]][3],coords[connections[cfg[b][1][posID]][connID]][4], 2, connections[cfg[b][1][posID]][connID]} )
		end
		table.insert ( bands, pedsTable )
		setTimer ( checkBand, 600000, 0, pedsTable )
		--outputChatBox ( "Бандиты появились в точке "..tostring(posID).." и отправляются в точку "..tostring(connections[posID][connID]) ) 
	end
	setTimer ( respawnBands, 3600000, 0 )
end

function respawnBands ()
	for i = 1, #bands do
		checkBand ( bands[i] )
		for b,v in ipairs ( bands[i] ) do
			if isElement ( v ) then 
				if getElementData ( v, "target" ) and b == 1 then return true end
				if isPedDead ( v ) then
					local offX = getElementData ( v, "offX" )
					local offY = getElementData ( v, "offY" ) 
					local weap = getElementData ( v, "weapon" )
					local posID = getElementData ( bands[i][1], "conn" )
					local x,y,z = getElementPosition ( bands[i][1] )
					local deadBanditShape = getElementData ( v, 'deadBanditShape' )
					if isElement ( deadBanditShape ) then
						destroyElement ( deadBanditShape )
					end
					destroyElement ( v )
					local createdPed = createPed ( 2, x+offX,y+offY,z )
					bands[i][b] = createdPed
					setElementData ( createdPed, "sphereLink", sphere )
					setElementData ( createdPed, "maxHealth", math.random ( 100, 400 ) )
					setElementData ( createdPed, "health", getElementData ( createdPed, 'maxHealth' ) )
					setElementData ( createdPed, "changes", 0 )
					setElementData ( createdPed, "bandID", 1 )
					setElementData ( createdPed, "conn", posID )
					setElementData ( createdPed, "offX", offX )
					setElementData ( createdPed, "offY", offY )
					setElementData ( createdPed, "bandit", true )
					exports.npc_hlc:enableHLCForNPC( createdPed, "walk")
					giveWeapon ( createdPed, weapon[weap][1], weapon[weap][2], true )
					setElementData ( createdPed, "weapon", weap )
					setPedArmor ( createdPed, weapon[weap][5] )
					setElementData ( createdPed, "attS", weapon[weap][3] )
					setElementData ( createdPed, "attD", weapon[weap][4] )
					exports.npc_hlc:addNPCTask ( createdPed, {"walkToPos", coords[posID][2],coords[posID][3],coords[posID][4], 2, posID} )
					--outputChatBox ('Бандит зареспавнен')
				end
			end
		end
	end
end

function checkBand ( banditos )
	local main = banditos[1]
	local x,y,z = getElementPosition ( banditos[1] )
	local mainShape = getElementData ( main, "sphereLink" )
	if isElement(mainShape) then
	--	if #getElementsWithinColShape ( mainShape, 'player' ) == 0 then
			for i = 2, #banditos do
				if isElement ( banditos[i] ) then
					if not isPedDead ( banditos[i] ) then
						local x2, y2, z2 = getElementPosition ( banditos[i] )
						if getDistanceBetweenPoints3D(x,y,z, x2, y2, z2) > 5 then
							setElementPosition ( banditos[i], x+getElementData (banditos[i],"offX"),y+getElementData (banditos[i],"offY"),z )
							--outputChatBox ( "Бандит "..tostring[i].." телепортирован к банде" )
						end
					end
				end
			end
		--end
	end
end

function banditMissionDone ( task )
	if getElementData ( source, "bandit" )  then
		if task[6] and task[1] == "walkToPos" then
			if getElementData ( source, "leader" ) then
				local connID = task[6]
				local nextPos = connections[connID][math.random(2,#connections[connID])]
				setElementData ( source, "conn", nextPos)
				--outputChatBox ( "Бандиты отправляются в точку "..tostring(nextPos) ) 
				exports.npc_hlc:addNPCTask ( source, {"walkToPos",coords[nextPos][2],coords[nextPos][3],coords[nextPos][4],2, nextPos} )
				for i, ped in ipairs(bands[getElementData ( source, "bandID" )]) do
					if i > 1 then
						local chX = getElementData ( ped, "offX" )
						local chY = getElementData ( ped, "offY" )
						exports.npc_hlc:addNPCTask ( ped, {"walkToPos",coords[nextPos][2]+chX,coords[nextPos][3]+chY,coords[nextPos][4],2, nextPos} )
					end
				end
			end
		elseif task[1] == "killPed" then
			local mainShape = getElementData ( source, "sphereLink" )
			if isElement(mainShape) then
				if #getElementsWithinColShape ( mainShape, 'player' ) == 0 then 
					local conn = getElementData ( source, "conn" ) 
					setElementPosition ( source, coords[conn][2], coords[conn][3], coords[conn][4] )
					local nextPos = connections[conn][math.random(2,#connections[conn])]
					exports.npc_hlc:addNPCTask ( source, {"walkToPos",coords[nextPos][2],coords[nextPos][3],coords[nextPos][4],2, nextPos} )
					checkBand ( bands[getElementData ( source, "bandID" )] )
					for i, ped in ipairs(bands[getElementData ( source, "bandID" )]) do
						if i > 1 then
							local chX = getElementData ( ped, "offX" )
							local chY = getElementData ( ped, "offY" )
							exports.npc_hlc:addNPCTask ( ped, {"walkToPos",coords[nextPos][2]+chX,coords[nextPos][3]+chY,coords[nextPos][4],2, nextPos} )
						end
					end
				end
			end
		end
	end
end 
 
addEventHandler ( "npc_hlc:onNPCTaskDone", root, banditMissionDone )

function setContinueWalk ( ped )
	local leader = bands[getElementData ( ped, "bandID" )][1]
	local conn = getElementData ( leader, "conn" ) 
	setElementPosition ( leader, coords[conn][2], coords[conn][3], coords[conn][4] )
	local nextPos = connections[conn][math.random(2,#connections[conn])]
	exports.npc_hlc:addNPCTask ( leader, {"walkToPos",coords[nextPos][2],coords[nextPos][3],coords[nextPos][4],2, nextPos} )
	checkBand ( bands[getElementData ( leader, "bandID" )] )
	for i, v in ipairs(bands[getElementData ( ped, "bandID" )]) do
		if i > 1 then
			local chX = getElementData ( v, "offX" )
			local chY = getElementData ( v, "offY" )
			setElementPosition ( v, coords[conn][2], coords[conn][3], coords[conn][4] )
			exports.npc_hlc:addNPCTask ( v, {"walkToPos",coords[nextPos][2]+chX,coords[nextPos][3]+chY,coords[nextPos][4],2, nextPos} )
		end
		exports.npc_hlc:setNPCWalkSpeed (v, "walk")
	end
end

-- function bandShapeEnter ( thePlayer, matchingDimension )
	-- if matchingDimension then
		-- if getElementType ( thePlayer ) == "player" then
			-- if getElementData ( source, "banditSphere" ) then
				-- if not getElementData ( thePlayer, "norLiveKilled" ) then
					-- local leader = getElementAttachedTo ( source )
					-- if isElement(leader) then
						-- local bandID = getElementData ( leader, "bandID" )
						-- if not getElementData ( leader, "target" ) then
							-- triggerClientEvent ( thePlayer, "playerBandChased", thePlayer, getElementData ( leader, "bandID" ), source, bands[getElementData ( leader, "bandID" )] )
						-- end
					-- end
				-- end
			-- end
		-- end
	-- end
-- end
-- addEventHandler ( "onColShapeHit", root, bandShapeEnter )

function chasedStartAttack (bandID)
		for i, v in ipairs(bands[bandID]) do
			if isElement(v) then
				if not isPedDead ( v ) and not isElement(getElementData ( v, "target" )) then
					setPedAnimation ( v )
					if exports.npc_hlc:isHLCEnabled ( v ) then
						exports.npc_hlc:clearNPCTasks ( v )
					else
						exports.npc_hlc:enableHLCForNPC( v, "run")
					end
					exports.npc_hlc:setNPCWalkSpeed (v, "run")
					local attS, attD = getElementData ( v, "attS" ), getElementData ( v, "attD" )
					exports.npc_hlc:addNPCTask ( v, {"killPed", source, attS, attD} )
					setElementData ( v, "target", source )
					setTimer ( checkBandTarget, 1000, 1, v )
					--outputChatBox ( 'Цель установлена' )
				end
			end
		end
end

addEvent( "chasedBandStartAttackC", true )
addEventHandler( "chasedBandStartAttackC", getRootElement(), chasedStartAttack )

function giveSyncedWeapon ()
	if getElementData ( source, "weapon" ) and getElementData ( source, "bandit" ) then
		giveWeapon ( source, weapon[getElementData ( source, "weapon" )][1], weapon[getElementData ( source, "weapon" )][2], true )
	end
end

addEventHandler( "onElementStartSync", getRootElement(), giveSyncedWeapon )

function checkBandTarget ( ped )
	if isElement ( ped ) then
		if not isPedDead ( ped ) then
			if getElementData ( ped, "leader" ) then
				local target = getElementData ( ped, "target" )
				if isElement ( target ) and not getElementData ( target, "norLiveKilled" ) then
					if getElementType ( target ) == "player" then
						local pX, pY, pZ = getElementPosition ( target )
						local zX, zY, zZ = getElementPosition ( ped )
						if (getDistanceBetweenPoints3D(pX, pY, pZ, zX, zY, zZ) > 70 ) then
							--outputChatBox ( 'Цель вышла из радиуса' )
							exports.npc_hlc:clearNPCTasks (ped)
							setElementData ( ped, "target", false )
							checkBandTarget ( ped )
							--setContinueWalk ( ped )
						else
							setTimer ( checkBandTarget, 1000, 1, ped )
						end
					end
				else
					local zSphere = getElementData ( ped, "sphereLink" )
					if zSphere then
						if isElement ( zSphere ) then
							--outputChatBox ( 'Поиск новой цели' )
							local zTargets = getElementsWithinColShape ( zSphere, "player" )
							local x,y,z = 9999, 9999, 9999
							local nearest = nil
							local zX, zY, zZ = getElementPosition ( ped )
							if zTargets then
								for theKey,thePlayer in ipairs(zTargets) do
									local pX, pY, pZ = getElementPosition ( thePlayer )
									if getDistanceBetweenPoints3D(pX, pY, pZ, zX, zY, zZ) < getDistanceBetweenPoints3D(x, y, z, zX, zY, zZ) and not getElementData ( localPlayer, "safezone.id" ) and not getElementData ( thePlayer, "norLiveKilled" ) then
										x,y,z = pX, pY, pZ
										nearest = thePlayer
									end
								end
							end
							if nearest then
								--outputChatBox ( 'Новая цель установлена' )
								local bandID = getElementData ( ped, "bandID" ) 
								for i, v in ipairs(bands[bandID]) do
									setElementData ( v, "target", nearest )
									setTimer ( checkBandTarget, 1000, 1, v )
									if isElement ( v ) then
										local attS, attD = getElementData ( v, "attS" ), getElementData ( v, "attD" )
										exports.npc_hlc:addNPCTask ( v, {"killPed", nearest, attS, attD} )
									end
								end
							else
								--outputChatBox ( 'Новой цели нету' )
								setContinueWalk ( ped )
							end
						end
					end
				end
			end
		end
	end
end

function caseBanditDamage (bandit,attacker,loss, health)
	if isElement ( bandit ) then
		if getElementData ( bandit, "bandit" ) then
			if not isPedDead ( bandit ) then
				local health = getElementData ( bandit,'health' )
				if health > loss then
					setElementData ( bandit,'health', health - loss )
					if getElementData ( bandit, "target" ) ~= source then
						if getElementData ( bandit, "changes" ) < 3 then
							setTimer ( function (ped) setElementData ( ped, "changes", getElementData ( ped,"changes" )-1) end, 1500, 1, bandit )
							exports.npc_hlc:clearNPCTasks ( bandit )
							local attS, attD = getElementData ( v, "attS" ), getElementData ( v, "attD" )
							setElementData ( bandit, "target", source )
							exports.npc_hlc:addNPCTask ( bandit, {"killPed", source, attS, attD} )
						end
					end
				else
					killPed ( bandit, source )
				end
			end
		end
	end
end

addEvent( "caseBanditDamageC", true )
addEventHandler( "caseBanditDamageC", getRootElement(), caseBanditDamage )
function banditWasted ( totalammo, theKiller)
	if getElementData ( source, "bandit" ) then
		if getElementData ( source, "leader" ) then
			local bandID = getElementData ( source, "bandID" ) 
			for i, v in ipairs(bands[bandID]) do
				if isElement ( v ) then
					if not isPedDead ( v ) then
						--outputChatBox ( 'Убит лидер банды' )
						local sphere = getElementData ( source, "sphereLink" )
						bands[bandID][i] = source
						setElementData ( source, "leader", false )
						bands[bandID][1] = v
						local offX, offY = getElementData ( v, "offX" ), getElementData ( v, "offY" )
						attachElements ( sphere, v )
						setElementData ( v, "sphereLink", sphere )
						setElementData ( v, "leader", true )
						setElementData ( v, "offX", 0 )
						setElementData ( v, "offY", 0 )
						setElementData ( source, "offX", offX )
						setElementData ( source, "offY", offY )
						break
					end
				end
			end
		end
		createDeadBandShape ( source )		
	end
end
addEventHandler("onPedWasted", root, banditWasted)

function createDeadBandShape ( ped )
	if isElement ( ped ) then
		local x,y,z = getElementPosition ( ped )
		local createdShape = createColSphere ( x, y,z, 2 )
		setElementData ( createdShape, "deadBandit", true )
		setElementData ( createdShape, "action", true )
		setElementData ( createdShape, "type", 6 )
		exports.loot:putItemsInCustomLoot ( createdShape, getElementData ( ped, 'itemsAmount' ) or 1 )
		setElementData ( ped, 'deadBanditShape', createdShape )
		setElementData ( ped, 'deadBanditPed', true )
	end
end


createBanditos ()